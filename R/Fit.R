library(zoo)
library(forecast)
library(tseries)
library(fUnitRoots)
library(FinTS)
library(timeDate)
library(timeSeries)
library(fBasics)
library(fGarch) 
library(rugarch)
library(TSA)

#Sorry for that we are not good at file io in R, and thus we process raw data in python and copy the processed data here
#You can check for detail in our python notebook :)

tsValuesLog = c(0.27178132292010393,0.2633637648005745,0.27649472681120435,0.2579700084662554,0.23878065209360871,0.19515551477404103,0.18573239991603624,0.20660758267411022,0.20163386782632747,0.18415321162292456,0.16458180031594477,0.17067061405309297,0.1927668146554932,0.1773090149704103,0.18465217213223703,0.20481663462132557,0.24427862384416804,0.23594130954407044,0.23751971725871687,0.24764102291459714,0.24074768526256682,0.23246001795155855,0.2537115528806275,0.2780104527550499,0.26182565790655354,0.268499253035007,0.281110527068742,0.3010670920619033,0.3014370376841166,0.2942355514216232,0.31670675149239724,0.3093946393574308,0.33002291294130587,0.3529781190944426,0.3841052689867548,0.3756242660971431,0.3871653509367311,0.38926797320559314,0.43954442176102704,0.45450920828708685,0.4417327472787058,0.4422469522006927,0.45482653764588854,0.4024605990878657,0.3606072024663374,0.2826192781093186,0.2424754796137017,0.30091907548377633,0.2809595266909542,0.24662567546141323,0.2662030407746567,0.2775559761527719,0.31086134539918625,0.33747173695429644,0.3430221674849455,0.35529399086180075,0.3767226392425104,0.39346000098073225,0.3993128886229662,0.37699704412863916,0.35529399086180075,0.3133498192003588,0.30527638085273207,0.2939374666142889,0.2281708930282351,0.20073432980108,0.2477190838802509,0.2548747494756633,0.27025611862840254,0.3293756870009098,0.31144742600204284,0.279221381533914,0.29050308963848276,0.31159389249809377,0.3378997886123983,0.3688011237365729,0.36011900634128746,0.36485142522286723,0.35592466254802824,0.35997947794703294,0.3182355254952373,0.3171437826013999,0.3043916860147281,0.2742168214982103,0.2554171118645054,0.28050638870268546,0.2782376136237812,0.2745968329031255,0.24732871810256474,0.22641818384786702,0.20522395001125893,0.21559513355688004,0.2534787511102827,0.26036226179681804,0.24974653310874384,0.2714764681048476,0.2854796488965809,0.28870654749796876,0.25874232855407314,0.2642854946453849,0.2610557163840707,0.2774044380406468,0.26911068686634554,0.2862310201844661,0.28997943150046446,0.31086134539918625,0.2994377034626343,0.3153945110183167,0.30880735406672916,0.31225272638598567,0.32411042906533244,0.3228078744271551,0.3176534109477654,0.3071169850903883,0.30254605410032287,0.2863061262718498,0.25378914142859677,0.237204234962544,0.22098121514952643,0.2093691178923701,0.14971227322832675,0.126632650933366,0.07871875471139075,0.07899600622649788,0.11037790746960939,0.11564742352596191,0.09503741533475163,0.10759801059801807,0.11591462459635593,0.1158255655055904,0.0701788346212465,0.0851680123698782,0.0820407103362094,0.10363903475948588,0.10741839676727029,0.1262801659103298,0.12327901616017124,0.1161817542894096,0.10029772131536387,0.11395349007584528,0.11493453809209941,0.09658209784624401,0.07622002591140901,0.05306672093669223,0.06156535565815473,0.06297479916138839,0.06681717303731709,0.06896620446472282,0.09984533496971612,0.11627078166538649,0.142367241286922,0.1666155269723372,0.17504514782317845,0.16169358899798714,0.16067222538889833,0.16856064154391753,0.19860492686705555,0.21026092548319605,0.20977458357525544,0.20457216572877446,0.16746169388693055,0.15520726430238263,0.15572087499677567,0.14384056997567313,0.1541792508476743,0.13871791931182273,0.12786537099789588,0.1292723357041391,0.1326059645480217,0.1265445413249562,0.12186358775684052,0.11635980111619525,0.11404271604066021)
tsValuesLog_d_1 = c(0,-0.008417558119529434,0.013130962010629854,-0.018524718344948954,-0.019189356372646682,-0.043625137319567686,-0.009423114858004789,0.020875182758073985,-0.004973714847782751,-0.017480656203402917,-0.019571411306979786,0.006088813737148202,0.022096200602400223,-0.015457799685082901,0.0073431571618267355,0.02016446248908854,0.03946198922284247,-0.008337314300097598,0.0015784077146464293,0.010121305655880264,-0.006893337652030318,-0.008287667311008273,0.021251534929068977,0.024298899874422353,-0.01618479484849633,0.006673595128453447,0.01261127403373502,0.019956564993161285,0.00036994562221331906,-0.007201486262493395,0.022471200070774022,-0.007312112134966464,0.02062827358387509,0.02295520615313673,0.03112714989231219,-0.008481002889611677,0.01154108483958799,0.002102622268862042,0.050276448555433895,0.014964786526059815,-0.012776461008381035,0.0005142049219868938,0.012579585445195829,-0.05236593855802285,-0.041853396621528316,-0.07798792435701879,-0.04014379849561689,0.05844359587007464,-0.019959548792822135,-0.03433385122954097,0.019577365313243444,0.011352935378115214,0.03330536924641436,0.02661039155511019,0.005550430530649075,0.012271823376855229,0.02142864838070968,0.016737361738221823,0.0058528876422339615,-0.022315844494327053,-0.021703053266838412,-0.04194417166144193,-0.008073438347626749,-0.011338914238443187,-0.06576657358605378,-0.027436563227155097,0.04698475407917091,0.0071556655954123916,0.015381369152739244,0.05911956837250726,-0.017928260998866963,-0.03222604446812882,0.011281708104568744,0.021090802859611013,0.026305896114304506,0.030901335124174645,-0.00868211739528546,0.00473241888157977,-0.008926762674838995,0.0040548153990047076,-0.04174395245179563,-0.0010917428938373996,-0.012752096586671813,-0.030174864516517796,-0.01879970963370492,0.025089276838180075,-0.0022687750789042727,-0.003640780720655712,-0.02726811480056074,-0.020910534254697716,-0.021194233836608095,0.01037118354562111,0.03788361755340264,0.006883510686535366,-0.0106157286880742,0.02172993499610376,0.014003180791733294,0.003226898601387862,-0.029964218943895615,0.00554316609131178,-0.003229778261314209,0.016348721656576082,-0.008293751174301256,0.017120333318120573,0.0037484113159983456,0.020881913898721793,-0.011423641936551931,0.015956807555682406,-0.006587156951587569,0.0034453723192565122,0.011857702679346771,-0.0013025546381773556,-0.005154463479389693,-0.010536425857377074,-0.004570930990065447,-0.016239927828473055,-0.03251698484325305,-0.016584906466052762,-0.016223019813017575,-0.01161209725715634,-0.059656844664043335,-0.023079622294960744,-0.047913896221975255,0.00027725151510712975,0.03138190124311151,0.005269516056352522,-0.020610008191210283,0.012560595263266444,0.008316613998337857,-8.905909076553642e-05,-0.0456467308843439,0.014989177748631705,-0.0031273020336688023,0.021598324423276485,0.0037793620077844065,0.018861769143059523,-0.0030011497501585688,-0.007097261870761637,-0.01588403297404574,0.013655768760481413,0.0009810480162541352,-0.018352440245855403,-0.020362071934834997,-0.023153304974716786,0.008498634721462499,0.0014094435032336594,0.0038423738759287007,0.0021490314274057315,0.030879130504993302,0.016425446695670365,0.026096459621535506,0.024248285685415205,0.008429620850841257,-0.013351558825191318,-0.0010213636090888045,0.007888416155019201,0.03004428532313802,0.0116559986161405,-0.00048634190794061283,-0.005202417846480983,-0.037110471841843906,-0.012254429584547921,0.0005136106943930407,-0.011880305021102544,0.010338680872001182,-0.01546133153585158,-0.010852548313926846,0.0014069647062432133,0.003333628843882608,-0.006061423223065493,-0.004680953568115695,-0.00550378664064527,-0.002317085075535033)

#Stationary test
print(adfTest(tsValuesLog,type = 'c'))
print(adfTest(tsValuesLog_d_1,lags = 1, type = 'c'))
for (i in c(50,60,70,80,90,100,110,120,130,140,150,160)){
    print(adfTest(tsValuesLog[0:i],type = 'c'))
}

#White Noise test
print(Box.test(tsValuesLog,lag=20,fitdf = 0))
print(Box.test(tsValuesLog_d_1,lag=20,fitdf = 0))

#Select models
acf(tsValuesLog_d_1)
pacf(tsValuesLog_d_1)
eacf(tsValuesLog_d_1)

#Test models
model = arima(tsValuesLog_d_1,order = c(1,0,0))
print(model)
print(Box.test(model$residuals,lag = 20,fitdf = 1))
print(ArchTest(model$residuals))

model = ARIMA(tsValuesLog_d_1,order=c(0,0,1))
print(model)
print(Box.test(model$residuals,lag = 20,fitdf = 1))
print(ArchTest(model$residuals))

model = arima(x = tsValuesLog_d_1,order = c(1,0,1))
print(model)
print(Box.test(model$residuals,lag=20,fitdf = 2))
print(ArchTest(model$residuals))

#Select GARCH models
model = arima(tsValuesLog_d_1,order = c(1,0,1))
res = model$residuals
res_sq = res**2
eacf(res_sq)

#Test GARCH models
myspec=ugarchspec(
    variance.model = list(model = "sGARCH", garchOrder = c(0, 2), submodel = NULL, external.regressors = NULL, variance.targeting = FALSE),
    mean.model = list(armaOrder = c(0,1), include.mean = TRUE, archm = FALSE, archpow = 1, arfima = FALSE, external.regressors = NULL, archex = FALSE),
    distribution.model = "norm"
)
myfit=ugarchfit(myspec,data=tsValuesLog_d_1,solver="solnp")
print(myfit)

myspec=ugarchspec(
    variance.model = list(model = "sGARCH", garchOrder = c(0, 2), submodel = NULL, external.regressors = NULL, variance.targeting = FALSE),
    mean.model = list(armaOrder = c(1,1), include.mean = TRUE, archm = FALSE, archpow = 1, arfima = FALSE, external.regressors = NULL, archex = FALSE),
    distribution.model = "norm"
)
myfit=ugarchfit(myspec,data=tsValuesLog_d_1,solver="solnp")
print(myfit)

myspec=ugarchspec(
    variance.model = list(model = "sGARCH", garchOrder = c(1, 2), submodel = NULL, external.regressors = NULL, variance.targeting = FALSE),
    mean.model = list(armaOrder = c(1,1), include.mean = TRUE, archm = FALSE, archpow = 1, arfima = FALSE, external.regressors = NULL, archex = FALSE),
    distribution.model = "norm"
)
myfit=ugarchfit(myspec,data=tsValuesLog_d_1,solver="solnp")
print(myfit)

myspec=ugarchspec(
    variance.model = list(model = "sGARCH", garchOrder = c(2, 2), submodel = NULL, external.regressors = NULL, variance.targeting = FALSE),
    mean.model = list(armaOrder = c(1,1), include.mean = TRUE, archm = FALSE, archpow = 1, arfima = FALSE, external.regressors = NULL, archex = FALSE),
    distribution.model = "norm"
)
myfit=ugarchfit(myspec,data=tsValuesLog_d_1,solver="solnp")
print(myfit)

myspec=ugarchspec(
    variance.model = list(model = "sGARCH", garchOrder = c(2, 1), submodel = NULL, external.regressors = NULL, variance.targeting = FALSE),
    mean.model = list(armaOrder = c(1,1), include.mean = TRUE, archm = FALSE, archpow = 1, arfima = FALSE, external.regressors = NULL, archex = FALSE),
    distribution.model = "norm"
)
myfit=ugarchfit(myspec,data=tsValuesLog_d_1,solver="solnp")
print(myfit)

myspec=ugarchspec(
    variance.model = list(model = "sGARCH", garchOrder = c(2, 3), submodel = NULL, external.regressors = NULL, variance.targeting = FALSE),
    mean.model = list(armaOrder = c(1,1), include.mean = TRUE, archm = FALSE, archpow = 1, arfima = FALSE, external.regressors = NULL, archex = FALSE),
    distribution.model = "norm"
)
myfit=ugarchfit(myspec,data=tsValuesLog_d_1,solver="solnp")
print(myfit)

myspec=ugarchspec(
    variance.model = list(model = "sGARCH", garchOrder = c(3, 3), submodel = NULL, external.regressors = NULL, variance.targeting = FALSE),
    mean.model = list(armaOrder = c(1,1), include.mean = TRUE, archm = FALSE, archpow = 1, arfima = FALSE, external.regressors = NULL, archex = FALSE),
    distribution.model = "norm"
)
myfit=ugarchfit(myspec,data=tsValuesLog_d_1,solver="solnp")
print(myfit)

#Picture
myspec=ugarchspec(
    variance.model = list(model = "sGARCH", garchOrder = c(2, 2), submodel = NULL, external.regressors = NULL, variance.targeting = FALSE),
    mean.model = list(armaOrder = c(1,1), include.mean = TRUE, archm = FALSE, archpow = 1, arfima = FALSE, external.regressors = NULL, archex = FALSE),
    distribution.model = "norm"
)
myfit=ugarchfit(myspec,data=tsValuesLog_d_1,solver="solnp")
plot(myfit,which = 'all')

myspec=ugarchspec(
    variance.model = list(model = "sGARCH", garchOrder = c(2, 2), submodel = NULL, external.regressors = NULL, variance.targeting = FALSE),
    mean.model = list(armaOrder = c(1,1), include.mean = TRUE, archm = FALSE, archpow = 1, arfima = FALSE, external.regressors = NULL, archex = FALSE),
    distribution.model = "norm"
)
myfit=ugarchfit(myspec,data=tsValuesLog_d_1,solver="solnp",out.sample = 100)
forc = ugarchforecast(myfit,n.ahead = 10,n.roll = 70)
plot(forc,which='all')

#then we do out-of-sample test
#detail could be checked in notebook
